<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High Gain Trigger</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; text-align: center; overflow: hidden; }
        #startBtn { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 20px 40px; font-size: 24px; background: red; color: white; border: none; border-radius: 10px; cursor: pointer; z-index: 100;
        }
        #debug { position: fixed; bottom: 10px; left: 0; width: 100%; font-size: 14px; color: lime; }
        .bar-container { width: 80%; height: 30px; background: #333; margin: 20px auto; border: 1px solid #555; position: relative; }
        .bar-fill { height: 100%; background: lime; width: 0%; transition: width 0.1s; }
        h1 { margin-top: 50px; }
    </style>
</head>
<body>

    <button id="startBtn" onclick="startSystem()">ğŸ”¥ Ø§Ø¶ØºØ· Ù„Ù„ØªØ´ØºÙŠÙ„ Ø¨Ù‚ÙˆØ© Ù‚ØµÙˆÙ‰</button>
    
    <h1 id="status">Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØªÙˆÙ‚Ù</h1>

    <div class="bar-container">
        <div id="visualBar" class="bar-fill"></div>
    </div>
    <p>Ù…Ø¤Ø´Ø± Ù‚ÙˆØ© Ø§Ù„Ø¥Ø´Ø§Ø±Ø© (14kHz)</p>

    <div id="debug">Ø§Ù†ØªØ¸Ø§Ø±...</div>

    <script>
        let audioContext;
        let analyser;
        let dataArray;
        let gainNode; // Ø³Ø± Ø§Ù„Ø®Ù„Ø·Ø©: Ù…Ø¶Ø®Ù… Ø§Ù„ØµÙˆØª

        async function startSystem() {
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('status').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø¨Ø­Ø³Ø§Ø³ÙŠØ© 1000%...";
            
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Ø·Ù„Ø¨ Ø§Ù„Ù…Ø§ÙŠÙƒ
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioContext.createMediaStreamSource(stream);

                // 1. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¶Ø®Ù… Ù„Ù„ØµÙˆØª (GainNode)
                gainNode = audioContext.createGain();
                gainNode.gain.value = 10.0; // ØªØ¶Ø®ÙŠÙ… Ø§Ù„ØµÙˆØª 10 Ø£Ø¶Ø¹Ø§Ù!!
                
                // 2. Ø§Ù„Ù…Ø­Ù„Ù„
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                
                // Ø§Ù„ØªÙˆØµÙŠÙ„: Ù…Ø§ÙŠÙƒ -> Ù…Ø¶Ø®Ù… -> Ù…Ø­Ù„Ù„
                source.connect(gainNode);
                gainNode.connect(analyser);

                dataArray = new Uint8Array(analyser.frequencyBinCount);

                detectLoop();

            } catch (e) {
                alert("Ø§Ù„Ù…ØªØµÙØ­ Ø±Ø§ÙØ¶ Ø§Ù„Ù…Ø§ÙŠÙƒ. ØªØ£ÙƒØ¯ Ù…Ù† Settings > Site Settings > Microphone");
                document.getElementById('status').innerText = "ÙØ´Ù„: " + e;
            }
        }

        function detectLoop() {
            requestAnimationFrame(detectLoop);
            analyser.getByteFrequencyData(dataArray);

            let sampleRate = audioContext.sampleRate;
            
            // Ø¯Ø§Ù„Ø© Ù„Ù„Ø¨Ø­Ø« ÙÙŠ "Ù†Ø·Ø§Ù‚" ÙˆÙ„ÙŠØ³ Ø±Ù‚Ù… ÙˆØ§Ø­Ø¯
            function getMaxVolumeInRange(targetFreq) {
                let centerBin = Math.round(targetFreq * analyser.fftSize / sampleRate);
                let maxVal = 0;
                // ÙØ­Øµ 5 Ø¯Ø±Ø¬Ø§Øª ÙŠÙ…ÙŠÙ† ÙˆØ´Ù…Ø§Ù„ Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø§Ù„ØªØ±Ø¯Ø¯ Ù…Ø±Ø­Ù„
                for (let i = centerBin - 5; i <= centerBin + 5; i++) {
                    if (dataArray[i] > maxVal) maxVal = dataArray[i];
                }
                return maxVal;
            }

            // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¶Ø®ÙŠÙ…
            let vol14k = getMaxVolumeInRange(14000);
            let vol19k = getMaxVolumeInRange(19000);

            // Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙˆØ© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© (Ø¹Ø´Ø§Ù† ØªØµØ¯Ù‚Ù†ÙŠ Ø¥Ù†Ù‡ Ø´ØºØ§Ù„)
            document.getElementById('visualBar').style.width = (vol14k / 2.55) + "%";
            document.getElementById('debug').innerText = `14k: ${vol14k} | 19k: ${vol19k}`;

            // Ø´Ø±Ø· Ø§Ù„ØªØ´ØºÙŠÙ„ (Ø¨Ù…Ø§ Ø¥Ù†Ù†Ø§ Ø¶Ø®Ù…Ù†Ø§ Ø§Ù„ØµÙˆØªØŒ Ù‡Ù†Ø¹Ù„ÙŠ Ø§Ù„Ø´Ø±Ø· Ø´ÙˆÙŠØ© Ø¹Ø´Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©)
            // Ø£ÙŠ Ø±Ù‚Ù… ÙÙˆÙ‚ 50 ÙŠØ¹ØªØ¨Ø± Ø¥Ø´Ø§Ø±Ø© Ù‚ÙˆÙŠØ© Ø§Ù„Ø¢Ù†
            if (vol19k > 50) {
                document.body.style.backgroundColor = "white"; // ÙÙ„Ø§Ø´
                document.getElementById('status').innerText = "FLASH !!!";
                document.getElementById('status').style.color = "black";
            } 
            else if (vol14k > 50) {
                document.body.style.backgroundColor = "yellow"; // ØµÙˆØª
                document.getElementById('status').innerText = "SOUND DETECTED !!!";
                document.getElementById('status').style.color = "black";
            } 
            else {
                document.body.style.backgroundColor = "black";
                document.getElementById('status').style.color = "white";
            }
        }
    </script>
</body>
</html>
