<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NATAS | FINAL</title>
    <style>
        /* إخفاء كل شيء وتجهيز السواد */
        body {
            background-color: #000;
            color: #ff003c;
            font-family: monospace;
            margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            user-select: none; -webkit-user-select: none;
        }

        /* شاشة التحميل (الوحيدة اللي بتظهر في الأول) */
        #loader {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%; background: #000; z-index: 999;
        }

        .logo {
            font-size: 3rem; border: 2px solid #ff003c; padding: 10px 20px;
            box-shadow: 0 0 15px #ff003c; text-shadow: 0 0 10px #ff003c;
            margin-bottom: 30px;
        }

        .btn {
            background: transparent; color: #ff003c; font-size: 1.5rem;
            padding: 15px 50px; border: 2px solid #ff003c; cursor: pointer;
            box-shadow: 0 0 10px #ff003c;
        }

        /* الشاشة السوداء الوهمية (بعد الاتصال) */
        #black-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; cursor: none; display: none; z-index: 100;
        }
        /* نقطة صغيرة جداً عشان تعرف إن التطبيق شغال (اختياري) */
        #indicator {
            position: absolute; bottom: 5px; right: 5px; width: 2px; height: 2px;
            background: #111; border-radius: 50%; animation: blink 2s infinite;
        }

        /* الكشاف */
        #flash-ui {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; display: none; z-index: 200;
        }

        /* البصمة */
        #bio-ui {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: none; flex-direction: column;
            align-items: center; justify-content: center; z-index: 200;
        }
        .scanner {
            width: 100px; height: 150px; border: 4px solid #ff003c; border-radius: 50px;
            position: relative; overflow: hidden; box-shadow: 0 0 30px #ff003c;
        }
        .laser {
            width: 100%; height: 4px; background: #0f0; position: absolute;
            animation: scan 1.5s infinite;
        }

        @keyframes blink { 0%,100%{opacity:0} 50%{opacity:1} }
        @keyframes scan { 0%{top:0%} 50%{top:100%} 100%{top:0%} }
    </style>
</head>
<body>

    <div id="loader">
        <div class="logo">N A T A S</div>
        <p style="color:#666; font-size:0.8rem;">V 6.0 // FINAL</p>
        <button class="btn" onclick="startSystem()">[ اتصال ]</button>
    </div>

    <div id="black-screen" onclick="reWakeLock()">
        <div id="indicator"></div>
    </div>

    <div id="flash-ui"></div>
    <div id="bio-ui">
        <div class="scanner" onmousedown="bioSuccess()" ontouchstart="bioSuccess()">
            <div class="laser"></div>
        </div>
        <p id="bio-msg" style="margin-top:20px; color:#ff003c;">SCAN...</p>
    </div>

    <audio id="sfx" src="whisper.mp3" preload="auto"></audio>

    <script>
        let wakeLock = null;
        let videoTrack = null;
        let audioContext, analyser;
        let lastTrigger = 0;

        async function startSystem() {
            // تشغيل الصوت الصامت لفك الحظر
            const sfx = document.getElementById('sfx');
            try { await sfx.play(); sfx.pause(); sfx.currentTime=0; } catch(e){}

            try {
                // طلب الصلاحيات
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" }, audio: true 
                });
                videoTrack = stream.getVideoTracks()[0];

                // إعداد المحلل الصوتي
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const src = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                src.connect(analyser);

                // بدء الاستماع
                listenLoop();
                reWakeLock();

                // إخفاء زر الاتصال وإظهار الشاشة السوداء
                document.getElementById('loader').style.display = 'none';
                document.getElementById('black-screen').style.display = 'block';

            } catch(err) {
                alert("يجب الموافقة على الكاميرا والميكروفون!");
            }
        }

        function listenLoop() {
            const buffer = analyser.frequencyBinCount;
            const data = new Uint8Array(buffer);
            
            function detect() {
                analyser.getByteFrequencyData(data);
                const nyquist = audioContext.sampleRate / 2;
                const getIndex = (f) => Math.round(f/nyquist * buffer);

                // كشف الترددات (حساسية 100)
                if (data[getIndex(19000)] > 100) trigger('flash');
                if (data[getIndex(16000)] > 100) trigger('bio');
                if (data[getIndex(14000)] > 100) trigger('sound');
                
                requestAnimationFrame(detect);
            }
            detect();
        }

        function trigger(type) {
            const now = Date.now();
            if (now - lastTrigger < 5000) return; 
            lastTrigger = now;

            if (type === 'flash') {
                const ui = document.getElementById('flash-ui');
                ui.style.display = 'block'; // إظهار الشاشة البيضاء
                // تشغيل الفلاش الحقيقي
                if(videoTrack) videoTrack.applyConstraints({advanced:[{torch:true}]}).catch(e=>{});
                
                setTimeout(() => {
                    ui.style.display = 'none'; // العودة للسواد
                    if(videoTrack) videoTrack.applyConstraints({advanced:[{torch:false}]}).catch(e=>{});
                }, 5000);
            }
            
            if (type === 'bio') {
                document.getElementById('bio-ui').style.display = 'flex';
            }

            if (type === 'sound') {
                const sfx = document.getElementById('sfx');
                sfx.currentTime = 0; sfx.play();
                if(navigator.vibrate) navigator.vibrate(500);
            }
        }

        function bioSuccess() {
            const frame = document.querySelector('.scanner');
            const msg = document.getElementById('bio-msg');
            
            frame.style.borderColor = '#0f0';
            frame.style.boxShadow = '0 0 50px #0f0';
            msg.innerText = "GRANTED";
            msg.style.color = '#0f0';
            if(navigator.vibrate) navigator.vibrate(100);
            
            setTimeout(() => {
                document.getElementById('bio-ui').style.display = 'none';
                frame.style.borderColor = '#ff003c';
                msg.innerText = "SCAN...";
                msg.style.color = '#ff003c';
            }, 2000);
        }

        async function reWakeLock() {
            if('wakeLock' in navigator) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
            }
        }
    </script>
</body>
</html>
