<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Force Resume Mic</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; text-align: center; padding-top: 50px; }
        button { padding: 20px 40px; font-size: 22px; background: #00E676; color: #000; border: none; border-radius: 8px; font-weight: bold; margin-bottom: 20px; }
        .stat { font-size: 18px; color: #aaa; margin: 10px 0; }
        .val { font-size: 30px; font-weight: bold; color: yellow; }
        #statusBox { padding: 10px; border: 1px solid #333; margin: 20px; background: #111; }
    </style>
</head>
<body>

    <button onclick="startAndResume()">ğŸš€ ØªØ´ØºÙŠÙ„ ÙˆØ¥Ø¬Ø¨Ø§Ø± Ø§Ù„ØµÙˆØª</button>

    <div id="statusBox">
        Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø±Ùƒ: <span id="ctxState" style="color:red">ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ</span>
    </div>

    <div class="stat">Ù‚ÙˆØ© Ø¥Ø´Ø§Ø±Ø© 14000Hz</div>
    <div id="vol14" class="val">0</div>

    <div class="stat">Ù‚ÙˆØ© Ø¥Ø´Ø§Ø±Ø© 19000Hz</div>
    <div id="vol19" class="val">0</div>

    <script>
        let audioContext;
        let analyser;
        let dataArray;
        let isRunning = false;

        async function startAndResume() {
            try {
                // 1. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³ÙŠØ§Ù‚ Ø§Ù„ØµÙˆØªÙŠ
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                // 2. Ø£Ù‡Ù… Ø®Ø·ÙˆØ©: Ù„Ùˆ ÙƒØ§Ù† "Ù…Ø¹Ù„Ù‚" Ù†Ø®Ù„ÙŠÙ‡ "Ø´ØºØ§Ù„"
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                // 3. Ø·Ù„Ø¨ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 1024;
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„
                document.querySelector('button').style.display = 'none';
                isRunning = true;
                loop();

            } catch (e) {
                alert("Ø®Ø·Ø£: " + e);
            }
        }

        function loop() {
            if (!isRunning) return;
            requestAnimationFrame(loop);
            analyser.getByteFrequencyData(dataArray);

            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø±Ùƒ Ù‚Ø¯Ø§Ù… Ø¹ÙŠÙ†Ùƒ
            const stateLabel = document.getElementById('ctxState');
            stateLabel.innerText = audioContext.state; // Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† "running"
            stateLabel.style.color = (audioContext.state === 'running') ? 'lime' : 'red';

            // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØªØ±Ø¯Ø¯Ø§Øª (Ù…Ø¹ Ù‡Ø§Ù…Ø´ Ø®Ø·Ø£ Ø¨Ø³ÙŠØ·)
            const sampleRate = audioContext.sampleRate;
            
            // Ø¯Ø§Ù„Ø© ØªØ¬Ù…Ø¹ Ø§Ù„Ø·Ø§Ù‚Ø© Ø­ÙˆÙ„ Ø§Ù„ØªØ±Ø¯Ø¯
            function getEnergy(freq) {
                const index = Math.round(freq * analyser.fftSize / sampleRate);
                // Ù†Ø¬Ù…Ø¹ 3 Ø®Ø§Ù†Ø§Øª Ø¹Ø´Ø§Ù† Ù†Ø¶Ù…Ù† Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØª
                return (dataArray[index] + dataArray[index-1] + dataArray[index+1]) / 3;
            }

            let v14 = getEnergy(14000);
            let v19 = getEnergy(19000);

            // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…
            document.getElementById('vol14').innerText = Math.floor(v14);
            document.getElementById('vol19').innerText = Math.floor(v19);

            // Ø§Ù„ØªÙØ§Ø¹Ù„
            if (v19 > 10) document.body.style.backgroundColor = "white";
            else if (v14 > 10) document.body.style.backgroundColor = "yellow";
            else document.body.style.backgroundColor = "black";
        }

        // ÙƒÙˆØ¯ Ø¥Ø¶Ø§ÙÙŠ: Ø£ÙŠ Ù„Ù…Ø³Ø© Ù„Ù„Ø´Ø§Ø´Ø© ØªØ­Ø§ÙˆÙ„ ØªØ´ØºÙ„ Ø§Ù„ØµÙˆØª ØªØ§Ù†ÙŠ Ù„Ùˆ ÙØµÙ„
        document.body.addEventListener('click', function() {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        });
    </script>
</body>
</html>
