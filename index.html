    <script>
        // المتغيرات العامة
        let wakeLock = null;
        let videoTrack = null;
        let audioContext = null;
        let analyser = null;
        let lastTriggerTime = 0; // لمنع التكرار السريع

        const debugLog = document.getElementById('debug-log');

        function log(msg) {
            console.log(msg);
            // debugLog.innerHTML = msg + " | " + debugLog.innerHTML; // شيل الشرطتين لو عايز تشوف الأخطاء
        }

        // 1. التهيئة (عند ضغط زر اتصال)
        async function initializeSystem() {
            log("Initializing...");

            // فك حظر الصوت
            const audio = document.getElementById('sfx');
            try {
                await audio.play();
                audio.pause();
                audio.currentTime = 0;
            } catch(e) {}

            try {
                // إعداد الميكروفون وتحليل الصوت
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // طلب الصلاحيات
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" }, 
                    audio: true 
                });
                
                videoTrack = stream.getVideoTracks()[0];
                
                // ربط المحلل الصوتي
                const microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048; // دقة عالية
                microphone.connect(analyser);

                // بدء الاستماع
                listenForSignals();
                
                // تفعيل منع النوم
                requestWakeLock();

                // فتح الواجهة
                document.getElementById('loader').style.display = 'none';
                document.getElementById('theater-ui').style.display = 'flex';

            } catch (err) {
                alert("يجب السماح للكاميرا والميكروفون!");
                // السماح بالدخول للطوارئ
                document.getElementById('loader').style.display = 'none';
                document.getElementById('theater-ui').style.display = 'flex';
            }
        }

        // 2. حلقة الاستماع للترددات (The Listener Loop)
        function listenForSignals() {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function detect() {
                analyser.getByteFrequencyData(dataArray);

                // حساب مكان التردد بدقة بناءً على Sample Rate للجهاز
                const nyquist = audioContext.sampleRate / 2;
                const getIndex = (freq) => Math.round(freq / nyquist * bufferLength);

                // فحص التردد 19000Hz (للكشاف)
                const index19k = getIndex(19000);
                if (dataArray[index19k] > 150) { // الحساسية (150 من 255)
                    triggerOnce('flash');
                }

                // فحص التردد 16000Hz (للبصمة)
                const index16k = getIndex(16000);
                if (dataArray[index16k] > 150) {
                    triggerOnce('bio');
                }

                requestAnimationFrame(detect);
            }
            detect();
        }

        // دالة لمنع التكرار (Debounce)
        function triggerOnce(type) {
            const now = Date.now();
            if (now - lastTriggerTime < 5000) return; // مهلة 5 ثواني بين كل مرة
            
            lastTriggerTime = now;
            
            if (type === 'flash') testFlash();
            if (type === 'bio') testBio();
        }

        // 3. الفلاش
        async function testFlash() {
            // تشغيل الشاشة البيضاء فوراً
            const flashUI = document.getElementById('flash-ui');
            flashUI.style.display = 'flex';

            // محاولة الهاردوير
            if (videoTrack) {
                try { await videoTrack.applyConstraints({ advanced: [{ torch: true }] }); } catch(e){}
            }

            setTimeout(async () => {
                flashUI.style.display = 'none';
                if (videoTrack) {
                    try { await videoTrack.applyConstraints({ advanced: [{ torch: false }] }); } catch(e){}
                }
            }, 5000); // مدة الفلاش
        }

        // 4. البصمة
        function testBio() {
            document.getElementById('bio-ui').style.display = 'flex';
        }

        function scanFinger() {
            const frame = document.querySelector('.scanner-frame');
            const laser = document.querySelector('.scan-laser');
            const text = document.getElementById('bio-text');

            frame.style.borderColor = '#00ff00';
            frame.style.boxShadow = '0 0 40px #00ff00';
            laser.style.background = '#00ff00';
            text.innerText = "ACCESS GRANTED";
            text.style.color = '#00ff00';
            
            if (navigator.vibrate) navigator.vibrate(100);

            setTimeout(() => {
                document.getElementById('bio-ui').style.display = 'none';
                frame.style.borderColor = 'var(--primary)';
                frame.style.boxShadow = '0 0 30px var(--primary)';
                text.innerText = "ضع بصمتك للإذن";
                text.style.color = 'var(--primary)';
            }, 2500);
        }

        // 5. الصوت
        function testSound() {
            const audio = document.getElementById('sfx');
            audio.currentTime = 0;
            audio.play();
            if (navigator.vibrate) navigator.vibrate(500);
        }

        async function requestWakeLock() {
            if ('wakeLock' in navigator && !wakeLock) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
            }
        }
    </script>
