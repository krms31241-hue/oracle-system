<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NATAS | ORACLE SYSTEM V2.0</title>
    <style>
        /* --- DESIGN SYSTEM: CYBERPUNK AESTHETICS --- */
        :root {
            --primary: #ff0000;
            --bg: #050505;
            --scanline: rgba(255, 0, 0, 0.1);
        }

        body {
            background-color: var(--bg);
            color: var(--primary);
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* تأثير خطوط التلفزيون القديم */
        body::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        /* الشاشات المختلفة */
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; /* مخفي افتراضياً */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        /* 1. شاشة الترحيب */
        #welcome-screen {
            display: flex;
            z-index: 20;
            background: var(--bg);
        }
        
        .logo {
            font-size: 3rem;
            letter-spacing: 10px;
            text-shadow: 0 0 10px var(--primary);
            animation: glitch 1s linear infinite;
            margin-bottom: 20px;
        }

        .btn {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
            padding: 15px 40px;
            font-size: 1.2rem;
            cursor: pointer;
            box-shadow: 0 0 15px var(--primary);
            transition: 0.3s;
            font-family: inherit;
            font-weight: bold;
        }
        .btn:active {
            background: var(--primary);
            color: #000;
        }

        /* 2. وضع السينما (الشاشة السوداء) */
        #theater-mode {
            background: #000;
            z-index: 15;
            cursor: pointer;
        }
        .status-text {
            color: #111; /* رمادي غامق جداً */
            font-size: 0.8rem;
            animation: breathe 3s infinite;
        }

        /* 3. وضع الكشاف */
        #flashlight-mode {
            background: #fff;
            z-index: 30;
        }

        /* 4. وضع البصمة */
        #bio-mode {
            background: rgba(0,0,0,0.95);
            z-index: 30;
        }
        .fingerprint-scanner {
            width: 120px;
            height: 160px;
            border: 3px solid var(--primary);
            border-radius: 60px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px var(--primary);
        }
        .scan-line {
            width: 100%;
            height: 5px;
            background: var(--primary);
            position: absolute;
            top: 0;
            animation: scan 1.5s linear infinite;
            box-shadow: 0 0 10px var(--primary);
        }
        .finger-text {
            margin-top: 20px;
            font-size: 1.2rem;
            text-shadow: 0 0 5px var(--primary);
        }

        /* Animations */
        @keyframes glitch {
            2%, 64% { transform: translate(2px,0) skew(0deg); }
            4%, 60% { transform: translate(-2px,0) skew(0deg); }
            62% { transform: translate(0,0) skew(5deg); }
        }
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
        @keyframes breathe {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.5; }
        }

        /* أزرار الاختبار (للتجربة اليدوية) - مخفية في العرض النهائي */
        .debug-controls {
            position: absolute;
            bottom: 20px;
            z-index: 100;
            opacity: 0.3;
        }
        .debug-btn {
            font-size: 10px;
            padding: 5px;
            background: #333;
            color: #fff;
            border: 1px solid #555;
            margin: 2px;
        }
    </style>
</head>
<body>

    <div id="welcome-screen" class="screen">
        <div class="logo">N A T A S</div>
        <p>نظام المزامنة العصبية V2.0</p>
        <br>
        <p style="font-size: 0.8rem; opacity: 0.8;">
            تعليمات:
            <br>1. اضغط "اتصال".
            <br>2. وافق على الميكروفون.
            <br>3. لا تقفل الشاشة.
        </p>
        <br>
        <button class="btn" onclick="initSystem()">[ اتصال ]</button>
    </div>

    <div id="theater-mode" class="screen" onclick="keepAwake()">
        <div class="logo" style="font-size: 1.5rem; opacity: 0.1;">N A T A S</div>
        <div class="status-text">LISTENING FOR SIGNAL... (19kHz)</div>
        <div class="status-text" style="margin-top: 10px;">TAP SCREEN TO KEEP AWAKE</div>
    </div>

    <div id="flashlight-mode" class="screen"></div>

    <div id="bio-mode" class="screen">
        <div class="fingerprint-scanner" ontouchstart="activateBio()" onmousedown="activateBio()">
            <div class="scan-line"></div>
        </div>
        <div class="finger-text" id="bio-text">ضع بصمتك للإذن</div>
    </div>

    <audio id="whisper-audio" src="whisper.mp3" preload="auto"></audio>

    <div class="debug-controls">
        <button class="debug-btn" onclick="triggerFlashlight()">TEST LIGHT</button>
        <button class="debug-btn" onclick="triggerBio()">TEST BIO</button>
        <button class="debug-btn" onclick="triggerWhisper()">TEST AUDIO</button>
    </div>

    <script>
        /* --- LOGIC CORE --- */
        let audioContext;
        let analyser;
        let microphone;
        let wakeLock = null;

        // دالة البدء
        async function initSystem() {
            // 1. تفعيل وضع ملء الشاشة
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            }

            // 2. تفعيل منع النوم
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                console.log("Wake Lock Active");
            } catch (err) {
                console.log("Wake Lock Error: " + err);
            }

            // 3. تفعيل الميكروفون وتحليل الصوت
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                
                analyser.fftSize = 256; // دقة التحليل
                microphone.connect(analyser);
                
                // البدء في الاستماع
                listenForSignal();
                
                // الانتقال لوضع السينما
                document.getElementById('welcome-screen').style.display = 'none';
                document.getElementById('theater-mode').style.display = 'flex';

            } catch (err) {
                alert("يجب السماح بالميكروفون ليعمل النظام!");
            }
        }

        // دالة الاستماع للتردد (The Listener)
        function listenForSignal() {
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function loop() {
                analyser.getByteFrequencyData(dataArray);

                // البحث عن ترددات عالية (High Pitch) - حوالي 18kHz-20kHz
                // في fftSize 256 مع معدل ترميز 44.1kHz، الترددات العالية تكون في الـ Bins الأخيرة (100-128)
                
                // مثال: لو القيمة في الـ Bin رقم 120 عالية جداً -> نفذ الكشاف
                if (dataArray[120] > 200) { 
                    triggerFlashlight(); // الكشاف
                }
                
                // مثال: تردد أقل قليلاً للبصمة
                else if (dataArray[100] > 200) {
                    triggerBio(); // البصمة
                }

                requestAnimationFrame(loop);
            }
            loop();
        }

        /* --- TRIGGERS (المؤثرات) --- */

        // 1. الكشاف
        function triggerFlashlight() {
            const screen = document.getElementById('flashlight-mode');
            screen.style.display = 'flex';
            // إيقاف بعد 10 ثواني
            setTimeout(() => {
                screen.style.display = 'none';
            }, 10000);
        }

        // 2. البصمة
        function triggerBio() {
            const screen = document.getElementById('bio-mode');
            screen.style.display = 'flex';
        }

        function activateBio() {
            // تغيير اللون للأخضر عند اللمس
            const scanner = document.querySelector('.fingerprint-scanner');
            const text = document.getElementById('bio-text');
            
            scanner.style.borderColor = '#0f0';
            scanner.style.boxShadow = '0 0 20px #0f0';
            document.querySelector('.scan-line').style.background = '#0f0';
            text.style.color = '#0f0';
            text.innerHTML = "تم القبول";
            
            // اهتزاز
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);

            // إخفاء بعد 2 ثانية
            setTimeout(() => {
                document.getElementById('bio-mode').style.display = 'none';
                // إعادة الضبط
                scanner.style.borderColor = 'var(--primary)';
                text.innerHTML = "ضع بصمتك للإذن";
                text.style.color = 'var(--primary)';
            }, 2500);
        }

        // 3. الهمس
        function triggerWhisper() {
            const audio = document.getElementById('whisper-audio');
            audio.play().catch(e => console.log("Audio play failed"));
            
            // اهتزاز خفيف مع الهمس
            if (navigator.vibrate) navigator.vibrate(500);
        }

        // دالة للحفاظ على الشاشة نشطة عند اللمس
        async function keepAwake() {
            if (wakeLock === null) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                } catch (e) {}
            }
        }
    </script>
</body>
</html>
