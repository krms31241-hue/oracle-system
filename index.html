<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mic Truth Tester</title>
    <style>
        body { background: #000; color: #fff; font-family: sans-serif; text-align: center; padding: 20px; }
        button { padding: 25px; font-size: 22px; background: #FF3D00; color: #fff; border: none; border-radius: 10px; width: 100%; margin-bottom: 30px; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØµÙˆØª Ø§Ù„Ø¹Ø§Ù… */
        .bar-container { width: 100%; height: 50px; background: #333; border: 2px solid #555; position: relative; margin-bottom: 10px; }
        .bar-fill { height: 100%; background: lime; width: 0%; transition: width 0.05s; }
        
        .label { font-size: 20px; margin-bottom: 5px; text-align: right; }
        #status { font-size: 18px; color: #aaa; margin-top: 20px; }
    </style>
</head>
<body>

    <button id="btn" onclick="startMic()">ğŸ”Š Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ùˆ "ØµÙ‚Ù‘Ù"</button>

    <div class="label">Ù‡Ù„ Ø§Ù„Ù…Ø§ÙŠÙƒ Ø³Ø§Ù…Ø¹ Ø¯ÙˆØ´Ø©ØŸ (ØµÙˆØª Ø¹Ø§Ù…)</div>
    <div class="bar-container">
        <div id="volBar" class="bar-fill"></div>
    </div>
    <div id="volVal">0%</div>

    <br><hr><br>

    <div class="label">Ù‡Ù„ Ø³Ø§Ù…Ø¹ Ø§Ù„ØªØ±Ø¯Ø¯ 14000ØŸ</div>
    <div class="bar-container">
        <div id="freqBar" class="bar-fill" style="background: yellow;"></div>
    </div>
    <div id="freqVal">0</div>

    <p id="status">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</p>

    <script>
        let audioContext;
        let analyser;
        let dataArray;

        async function startMic() {
            const btn = document.getElementById('btn');
            const status = document.getElementById('status');

            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Ø¥Ø¬Ø¨Ø§Ø± ÙÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512; // Ø¯Ù‚Ø© Ø£Ù‚Ù„ Ø¹Ø´Ø§Ù† Ø§Ù„Ø³Ø±Ø¹Ø©
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                btn.style.display = 'none';
                status.innerText = "ğŸ¤ Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù†Ø´Ø·.. Ø§Ø¹Ù…Ù„ Ø¯ÙˆØ´Ø©!";
                status.style.color = "lime";

                loop();
            } catch (e) {
                alert("Ù…Ø´ÙƒÙ„Ø©: " + e);
            }
        }

        function loop() {
            requestAnimationFrame(loop);
            analyser.getByteFrequencyData(dataArray);

            // 1. Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„ØµÙˆØª Ø§Ù„Ø¹Ø§Ù… (Ù‡Ù„ Ø§Ù„Ù…Ø§ÙŠÙƒ Ø´ØºØ§Ù„ Ø£ØµÙ„Ø§Ù‹ØŸ)
            let sum = 0;
            for(let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            let averageVolume = sum / dataArray.length;

            // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· "Ø§Ù„Ø¯ÙˆØ´Ø©"
            let volPercent = Math.min(100, averageVolume * 2); // ØªØ¶Ø®ÙŠÙ… Ù„Ù„Ø¹Ø±Ø¶
            document.getElementById('volBar').style.width = volPercent + "%";
            document.getElementById('volVal').innerText = Math.floor(volPercent) + "%";

            // 2. Ø­Ø³Ø§Ø¨ ØªØ±Ø¯Ø¯ 14000Hz Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ¯
            const sampleRate = audioContext.sampleRate;
            const targetIndex = Math.round(14000 * analyser.fftSize / sampleRate);
            // Ù†Ø§Ø®Ø¯ 3 Ø®Ø§Ù†Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ù‡Ø¯Ù
            let freqVol = (dataArray[targetIndex] + dataArray[targetIndex-1] + dataArray[targetIndex+1]) / 3;

            // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªØ±Ø¯Ø¯
            let freqPercent = Math.min(100, freqVol); 
            document.getElementById('freqBar').style.width = freqPercent + "%";
            document.getElementById('freqVal').innerText = Math.floor(freqVol);

            // Ø§Ù„ØªÙØ§Ø¹Ù„
            if (freqVol > 10) {
                document.body.style.backgroundColor = "yellow"; // Ù„Ù‚Ø· Ø§Ù„ØªØ±Ø¯Ø¯
                status.innerText = "âœ… ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø¥Ø´Ø§Ø±Ø©!";
                status.style.color = "black";
            } else if (volPercent > 10) {
                document.body.style.backgroundColor = "#222"; // Ø³Ø§Ù…Ø¹ ØµÙˆØª Ø¨Ø³ Ù…Ø´ Ø§Ù„ØªØ±Ø¯Ø¯
            }
        }
    </script>
</body>
</html>
